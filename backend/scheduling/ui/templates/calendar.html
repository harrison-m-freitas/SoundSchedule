{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Calendário" %} — {{ month_name|capfirst }} {{ year }}{% endblock %}

{% block content %}
<div id="calendar-toolbar-sentinel" class="h-px"></div>

<div class="sticky top-0 z-10">
  <div id="calendar-toolbar-inner"
       class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white border-b border-white/10
              rounded-xl transition-[border-radius] duration-200">
    <div class="max-w-5xl mx-auto px-3 py-3 sm:py-4 flex flex-col gap-2">

      <div class="flex items-center justify-between gap-2">
        <h1 class="text-base sm:text-lg md:text-xl font-semibold truncate drop-shadow-sm">
          {% trans "Calendário" %} — {{ month_name|capfirst }} {{ year }}
        </h1>

        <div class="flex items-center gap-1 sm:gap-2">
          <a class="px-3 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20 ring-1 ring-white/20"
              href="?year={{today_year}}&month={{today_month}}" title="{% trans 'Hoje' %} (T)">
            <span class="hidden sm:inline">{% trans "Hoje" %}</span>
            <span class="sm:hidden" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zM18 9H2v7a2 2 0 002 2h12a2 2 0 002-2V9z" />
              </svg>
            </span>
          </a>

          <div class="sm:hidden relative" x-data="{open:false}" @keydown.escape="open=false">
            <button type="button"
                      @click="open=!open"
                      class="px-3 py-2 rounded-lg bg-white/10 text-white ring-1 ring-white/20 hover:bg-white/20"
                      :aria-expanded="open.toString()" aria-haspopup="menu" aria-label="{% trans 'Mais ações' %}">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z" />
              </svg>
            </button>
            <div x-cloak x-show="open" @click.outside="open=false"
                class="absolute right-0 mt-2 w-56 bg-white text-gray-800 rounded-lg shadow-lg ring-1 ring-black/5 overflow-hidden z-40"
                role="menu">
              <a class="block px-3 py-2 hover:bg-gray-50" role="menuitem"
                href="/generate/?year={{year}}&month={{month}}">{% trans "Gerar sugestões" %}</a>
              {% if perms.scheduling.add_service %}
              <a class="block px-3 py-2 hover:bg-gray-50" role="menuitem"
                href="/services/new/?year={{year}}&month={{month}}">{% trans "Adicionar serviço extra" %}</a>
              {% endif %}

              <div class="border-t my-1"></div>
                <a class="block px-3 py-2 hover:bg-gray-50" role="menuitem"
                  href="/api/v1/export/xlsx?ano={{year}}&mes={{month}}">{% trans "Exportar Excel (.xlsx)" %}</a>
                <a class="block px-3 py-2 hover:bg-gray-50" role="menuitem"
                  href="/api/v1/export/ics?ano={{year}}&mes={{month}}">{% trans "Exportar Calendário (.ics)" %}</a>
              <div class="border-t my-1"></div>
              <a class="block px-3 py-2 hover:bg-gray-50" role="menuitem" href="#month-year-select"
                 @click.prevent="if (window.matchMedia('(max-width: 767px)').matches) { $store.ui.openMonth(); open=false }">
                {% trans "Mudar mês/ano" %}
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Line 2: Select Month/Year  + Full Actions -->
      <div id="month-year-select"
           class="hidden sm:flex flex-wrap items-center justify-center gap-2">
        <form method="get" class="ml-1 flex items-center gap-2">
          <label for="month-select" class="sr-only">{% trans "Mês" %}</label>
          <select id="month-select" name="month"
                  class="bg-white text-gray-900 rounded-lg border border-white/20 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-white/60">
            {% for m_num, m_name in months_select %}
              <option value="{{ m_num }}" {% if m_num == month %}selected{% endif %}>{{ m_name }}</option>
            {% endfor %}
          </select>
          <label for="year-select" class="sr-only">{% trans "Ano" %}</label>
          <select id="year-select" name="year"
                  class="bg-white text-gray-900 rounded-lg border border-white/20 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-white/60">
            {% for y in years_select %}
              <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
          <button type="submit"
                  class="px-3 py-2 rounded-lg bg-white text-indigo-700 hover:bg-indigo-50">
            Ir
          </button>
          <a class="px-3 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20 ring-1 ring-white/20"
             href="?year={{today_year}}&month={{today_month}}" title="{% trans 'Hoje' %} (T)">
            {% trans "Hoje" %}
          </a>
        </form>

        <div class="flex flex-wrap items-center justify-center gap-2">
          <a class="px-3 py-2 rounded-lg bg-white text-indigo-700 hover:bg-indigo-50"
               href="/generate/?year={{year}}&month={{month}}">
            {% trans "Gerar sugestões" %}
          </a>

          <details class="relative inline-block">
            <summary class="px-3 py-2 bg-white/10 text-white rounded-lg cursor-pointer select-none ring-1 ring-white/20 hover:bg-white/20">
              {% trans "Exportar" %}
            </summary>
            <div class="absolute right-0 mt-2 w-48 bg-white border rounded-lg shadow-lg overflow-hidden">
              <a class="block px-3 py-2 hover:bg-gray-50 text-gray-800"
                 href="/api/v1/export/xlsx?ano={{year}}&mes={{month}}">{% trans "Excel (.xlsx)" %}</a>
              <a class="block px-3 py-2 hover:bg-gray-50 text-gray-800"
                 href="/api/v1/export/ics?ano={{year}}&mes={{month}}">{% trans "Calendário (.ics)" %}</a>
            </div>
          </details>

          {% if perms.scheduling.add_service %}
          <a class="px-3 py-2 rounded-lg bg-white text-indigo-700 hover:bg-indigo-50"
             href="/services/new/?year={{year}}&month={{month}}">
            {% trans "Adicionar serviço extra" %}
          </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="max-w-5xl mx-auto px-2 mt-3">
  <div class="flex flex-wrap items-center gap-3 text-xs text-gray-600">
    <span class="inline-flex items-center gap-1">
      <span class="inline-block w-2 h-2 rounded-full bg_confirmed"></span> {% trans "Confirmado" %}
    </span>
    <span class="inline-flex items-center gap-1">
      <span class="inline-block w-2 h-2 rounded-full bg_suggested"></span> {% trans "Sugerido" %}
    </span>
    <span class="inline-flex items-center gap-1">
      <span class="inline-block w-2 h-2 rounded-full bg-gray-500"></span> {% trans "Outro" %}
    </span>
    <span class="ml-auto text-[11px] text-gray-500">
      {% trans "Atalhos" %}: ←/→ {% trans "navega" %} · T {% trans "hoje" %} · G {% trans "gerar" %} · X {% trans "Excel" %} · I {% trans "ICS" %} · A {% trans "novo extra" %}
    </span>
  </div>
</div>

<div class="max-w-5xl mx-auto">
  <div class="bg-white rounded-xl shadow-sm ring-1 ring-black/5 overflow-hidden">
    <div class="px-5 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
      <p class="text-sm opacity-90">{% trans "Clique para editar, trocar ou confirmar diretamente nos cards." %}</p>
    </div>

    <div class="md:hidden divide-y divide-gray-100" role="list">
      {% for day, obj in days %}
        <section role="listitem" aria-labelledby="day-{{day}}-label" class="p-3 hover:bg-gray-50">
          <div class="flex items-center gap-2 mb-2">
            <span id="day-{{day}}-label"
                  class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-indigo-50 text-indigo-900 font-semibold ring-1 ring-indigo-100">
              {{ day }}
            </span>
            <span class="text-sm text-gray-500">{{ month_name }} {{ year }}</span>
          </div>
          <div class="grid grid-cols-1 gap-3">
            {% for s in obj.services|dictsort:"time" %}
              {% include "partials/service_card.html" with s=s %}
            {% endfor %}
          </div>
        </section>
      {% endfor %}
    </div>

    <div class="hidden md:block overflow-x-auto">
      <table class="min-w-full table-fixed text-sm">
        <colgroup>
          <col style="width: 7rem;">
          <col>
        </colgroup>
        <thead class="bg-gray-50 text-gray-500 text-sm">
          <tr>
            <th class="p-2 text-left font-medium">{% trans "Dia" %}</th>
            <th class="p-2 text-left font-medium">{% trans "Serviços" %}</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for day, obj in days %}
            <tr class="align-top hover:bg-gray-50" role="row">
              <td class="p-3" role="cell">
                <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-indigo-50 text-indigo-900 font-semibold ring-1 ring-indigo-100">
                    {{ day }}
                </span>
              </td>
              <td class="p-3" role="cell">
                <div class="grid grid-cols-1 gap-3">
                  {% for s in obj.services|dictsort:"time" %}
                    {% include "partials/service_card.html" with s=s %}
                  {% endfor %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- Loader de ranking mensal (mantido) -->
<div
  id="ranking-monthly-loader"
  hx-get="{% url 'ranking_candidates' %}?year={{year}}&month={{month}}"
  hx-trigger="load ranking-changed from:body"
  hx-swap="none"
  aria-live="polite">
</div>

<div class="fixed inset-0 z-50 md:hidden"
     x-show="$store.ui.monthOpen" x-data
     x-transition.opacity x-cloak >
  <!-- backdrop -->
  <button class="absolute inset-0 bg-black/40" @click="$store.ui.closeMonth()" aria-label="{% trans 'Fechar' %}"></button>

  <!-- sheet inferior -->
  <div class="absolute inset-x-0 bottom-0 bg-white rounded-t-2xl p-4 shadow-xl"
       role="dialog" aria-modal="true" aria-labelledby="month-title">
    <div class="flex items-center justify-between">
      <h2 id="month-title" class="text-base font-semibold">{% trans "Mudar mês/ano" %}</h2>
      <button class="p-2 rounded hover:bg-gray-100" @click="$store.ui.closeMonth()" aria-label="{% trans 'Fechar' %}">✕</button>
    </div>

    <form method="get" action="." class="mt-3 grid grid-cols-2 gap-3"
          @submit="$store.ui.closeMonth()">
      <div>
        <label for="month-mobile-year" class="block text-sm text-gray-700 mb-1">{% trans "Ano" %}</label>
        <input id="month-mobile-year" name="year" type="number" inputmode="numeric"
               class="w-full rounded-lg border border-gray-300 px-3 py-2"
               min="2000" max="2100"
               value="{{ year }}">
      </div>

      <div>
        <label for="month-mobile-month" class="block text-sm text-gray-700 mb-1">{% trans "Mês" %}</label>
        <input id="month-mobile-month" name="month" type="number" inputmode="numeric"
               class="w-full rounded-lg border border-gray-300 px-3 py-2"
               min="1" max="12"
               value="{{ month }}">
      </div>

      <div class="col-span-2 mt-1 flex items-center justify-end gap-2">
        <button type="button" class="px-3 py-2 rounded-lg border" @click="$store.ui.closeMonth()">{% trans "Cancelar" %}</button>
        <button type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
          {% trans "Ir" %}
        </button>
      </div>
    </form>
  </div>
</div>


<style>
  .bg_suggested {
    background-color: #eab308;
  }
  .bg_confirmed {
    background-color: #16a34a;
  }
</style>
<script>
  // ← → navegação; T hoje; G gerar; X export XLSX; I export ICS; A serviço extra
  document.addEventListener('keydown', (e) => {
    if (['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
    if (e.key === 'ArrowLeft') { window.location = `?year={{prev_year}}&month={{prev_month}}`; }
    if (e.key === 'ArrowRight') { window.location = `?year={{next_year}}&month={{next_month}}`; }
    if (e.key.toLowerCase() === 't') { window.location = `?year={{today_year}}&month={{today_month}}`; }
    if (e.key.toLowerCase() === 'g') { window.location = `/generate/?year={{year}}&month={{month}}`; }
    if (e.key.toLowerCase() === 'x') { window.location = `/api/v1/export/xlsx?ano={{year}}&mes={{month}}`; }
    if (e.key.toLowerCase() === 'i') { window.location = `/api/v1/export/ics?ano={{year}}&mes={{month}}`; }
    if (e.key.toLowerCase() === 'a') { window.location = `/services/new/?year={{year}}&month={{month}}`; }
  });

  (function () {
    const sentinel = document.getElementById('calendar-toolbar-sentinel');
    const inner = document.getElementById('calendar-toolbar-inner');
    if (!sentinel || !inner) return;

    const io = new IntersectionObserver(([entry]) => {
      const stuck = entry.intersectionRatio === 0;
      inner.classList.toggle('rounded-b-xl', !stuck);
      inner.classList.toggle('rounded-none', stuck);
    }, { threshold: [0, 1] });

    io.observe(sentinel);
  })();

  (function initStoreWhenReady() {
    function ensureStore() {
      if (!Alpine.store('ui')) {
        Alpine.store('ui', {
          monthOpen: false,
          openMonth(){
            this.monthOpen = true;
            requestAnimationFrame(() => {
              const el = document.getElementById('month-mobile-year');
              if (el) el.focus({ preventScroll: true});
            });
          },
          closeMonth(){ this.monthOpen = false; }
        });
      }
    }
    if (window.Alpine) {
      ensureStore();
    } else {
      window.addEventListener('alpine:init',  ensureStore, { once: true });
    }
  })();
</script>

{% endblock %}
